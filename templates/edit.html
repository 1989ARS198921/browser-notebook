<!-- templates/edit.html -->
<!-- -*- coding: utf-8 -*- -->
{% extends "base.html" %}
{% block sidebar %}
    {% include 'sidebar.html' %}
{% endblock %}

{% block title %}{{ "Редактировать" if note.id else "Создать" }} запись{% endblock %}

{% block content %}
<div class="content-card">
    <div class="card-header">
        <h2>{{ "Редактировать" if note.id else "Создать" }} запись</h2>
    </div>
    <form method="POST" enctype="multipart/form-data" id="note-form" class="note-form">
        <!-- Плавающая метка для заголовка -->
        <div class="form-group">
            <label for="title" class="floating-label">Заголовок</label>
            <input type="text" id="title" name="title" value="{{ note.title }}" required class="form-input floating-input">
        </div>

        <!-- Плавающая метка для содержимого -->
        <div class="form-group">
            <label for="content" class="floating-label">Содержимое</label>
            <textarea id="content" name="content" class="form-textarea floating-input" rows="10">{{ note.content }}</textarea>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="type">Тип записи:</label>
                <select name="type" id="type" class="form-select">
                    <option value="note" {% if note.note_type == 'note' %}selected{% endif %}>Заметка</option>
                    <option value="list" {% if note.note_type == 'list' %}selected{% endif %}>Список</option>
                    <option value="image_note" {% if note.note_type == 'image_note' %}selected{% endif %}>Заметка с изображением</option>
                    <option value="article" {% if note.note_type == 'article' %}selected{% endif %}>Статья</option>
                </select>
            </div>
            <div class="form-group">
                <label for="background_color">Цвет фона:</label>
                <select name="background_color" id="background_color" class="form-select">
                    <option value="white" {% if note.background_color == 'white' %}selected{% endif %}>Белый</option>
                    <option value="yellow" {% if note.background_color == 'yellow' %}selected{% endif %}>Жёлтый</option>
                    <option value="blue" {% if note.background_color == 'blue' %}selected{% endif %}>Синий</option>
                    <option value="green" {% if note.background_color == 'green' %}selected{% endif %}>Зелёный</option>
                    <option value="red" {% if note.background_color == 'red' %}selected{% endif %}>Красный</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="categories">Категории:</label>
            <select name="categories" id="categories" multiple class="form-select">
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if category.id in current_category_ids %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="tags">Теги (через запятую):</label>
            <input type="text" id="tags" name="tags" value="{{ note.tags or '' }}" class="form-input" placeholder="важное, идея, проект">
        </div>

        <div class="form-group">
            <label for="image">Прикрепить изображение:</label>
            <input type="file" id="image" name="image" accept="image/*" class="form-input">
            {% if note.image_filename %}
                <p><img src="{{ url_for('static', filename='uploads/' + note.image_filename) }}" alt="Изображение к записи" style="max-width: 200px;"></p>
            {% endif %}
        </div>

        <!-- НОВОЕ: Чекбокс публикации -->
        <div class="form-group">
            <label>
                <input type="checkbox" name="is_published" value="1" {% if note.is_published %}checked{% endif %}> Опубликовать запись
            </label>
        </div>
        <!-- /НОВОЕ -->

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="{{ url_for('admin_index') }}" class="btn btn-cancel">Отмена</a>
        </div>
    </form>
</div>

<script>
  // --- Валидация формы ---
  const noteForm = document.getElementById('note-form');
  const titleInput = document.getElementById('title');
  const contentInput = document.getElementById('content');

  noteForm.addEventListener('submit', (e) => {
      let isValid = true;
      let errorMessage = '';

      if (!titleInput.value.trim()) {
          isValid = false;
          errorMessage += 'Заголовок обязателен. ';
      }

      if (!contentInput.value.trim()) {
          isValid = false;
          errorMessage += 'Содержимое обязательно. ';
      }

      if (!isValid) {
          e.preventDefault(); // Останавливаем отправку формы
          alert(errorMessage); // Показываем ошибку
          // Можно улучшить, показав ошибку в UI, а не через alert
      }
  });

  // --- Плавающие метки ---
  const floatingInputs = document.querySelectorAll('.floating-input');
  const updateFloatingLabels = (input) => {
      const label = input.previousElementSibling;
      if (input.value.trim() || input === document.activeElement) {
          label.classList.add('active');
      } else {
          label.classList.remove('active');
      }
  };

  floatingInputs.forEach(input => {
      input.addEventListener('focus', () => updateFloatingLabels(input));
      input.addEventListener('blur', () => updateFloatingLabels(input));
      input.addEventListener('input', () => updateFloatingLabels(input));
      // Инициализируем состояние при загрузке
      updateFloatingLabels(input);
  });
</script>

<style>
  /* --- Стили для плавающих меток --- */
  .form-group {
      position: relative;
  }

  .floating-input {
      padding-top: 1.25rem; /* Делаем отступ сверху для метки */
  }

  .floating-label {
      position: absolute;
      top: 0.75rem;
      left: 1rem;
      color: var(--secondary-text-color);
      pointer-events: none;
      transition: all 0.2s ease;
      font-size: 0.9rem;
  }

  .floating-label.active {
      top: 0.25rem;
      left: 0.5rem;
      font-size: 0.75rem;
      color: var(--highlight-color);
      background-color: var(--main-bg-color);
      padding: 0 0.25rem;
  }

  .form-input:focus + .floating-label,
  .form-textarea:focus + .floating-label {
      top: 0.25rem;
      left: 0.5rem;
      font-size: 0.75rem;
      color: var(--highlight-color);
      background-color: var(--main-bg-color);
      padding: 0 0.25rem;
  }

  .form-input:not(:placeholder-shown):not(:focus) + .floating-label,
  .form-textarea:not(:placeholder-shown):not(:focus) + .floating-label {
      top: 0.25rem;
      left: 0.5rem;
      font-size: 0.75rem;
      color: var(--highlight-color);
      background-color: var(--main-bg-color);
      padding: 0 0.25rem;
  }
  /* --- /Стили для плавающих меток --- */
</style>

{% endblock %}