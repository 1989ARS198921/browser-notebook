<!-- templates/edit.html -->
{% extends "base.html" %}
{% block sidebar %}
    {% include 'sidebar.html' %}
{% endblock %}

{% block title %}{{ "Редактировать" if note.id else "Создать" }} запись{% endblock %}

{% block content %}
<div class="content-card">
    <div class="card-header">
        <h2>{{ "Редактировать" if note.id else "Создать" }} запись</h2>
    </div>
    <form method="POST" enctype="multipart/form-data" class="note-form">
        <!-- Заголовок и Тип записи в одной строке -->
        <div class="form-row">
            <div class="form-group">
                <label for="title">Заголовок:</label>
                <input type="text" id="title" name="title" value="{{ note.title }}" required class="form-input">
            </div>
            <div class="form-group">
                <label for="type">Тип записи:</label>
                <select name="type" id="type" class="form-select">
                    <option value="note" {% if note.note_type == 'note' %}selected{% endif %}>Заметка</option>
                    <option value="article" {% if note.note_type == 'article' %}selected{% endif %}>Статья</option>
                </select>
            </div>
        </div>

        <!-- Категории -->
        <div class="form-row">
            <div class="form-group" style="width: 100%;">
                <label for="categories">Категории:</label>
                <select name="categories" id="categories" multiple class="form-select">
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id in current_category_ids %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Шрифт и Размер в одной строке -->
        <div class="form-row">
            <div class="form-group">
                <label for="font-family">Шрифт:</label>
                <select name="font-family" id="font-family" class="form-select">
                    <option value="Segoe UI" {% if note.font_family == 'Segoe UI' %}selected{% endif %}>Segoe UI</option>
                    <option value="Arial" {% if note.font_family == 'Arial' %}selected{% endif %}>Arial</option>
                    <option value="Times New Roman" {% if note.font_family == 'Times New Roman' %}selected{% endif %}>Times New Roman</option>
                    <option value="Courier New" {% if note.font_family == 'Courier New' %}selected{% endif %}>Courier New</option>
                    <option value="Georgia" {% if note.font_family == 'Georgia' %}selected{% endif %}>Georgia</option>
                    <option value="Verdana" {% if note.font_family == 'Verdana' %}selected{% endif %}>Verdana</option>
                </select>
            </div>
            <div class="form-group">
                <label for="font-size">Размер:</label>
                <select name="font-size" id="font-size" class="form-select">
                    <option value="small" {% if note.font_size == 'small' %}selected{% endif %}>Маленький</option>
                    <option value="medium" {% if note.font_size == 'medium' %}selected{% endif %}>Средний</option>
                    <option value="large" {% if note.font_size == 'large' %}selected{% endif %}>Большой</option>
                    <option value="x-large" {% if note.font_size == 'x-large' %}selected{% endif %}>Очень большой</option>
                </select>
            </div>
        </div>

        <!-- Содержимое -->
        <div class="form-row">
            <div class="form-group" style="width: 100%;">
                <label for="mytextarea">Содержимое:</label>
                <textarea id="mytextarea" name="content" class="form-textarea">{{ note.content }}</textarea>
            </div>
        </div>

        <!-- Прикрепить изображение -->
        <div class="form-row">
            <div class="form-group" style="width: 100%;">
                <label for="image">Прикрепить изображение (внешнее):</label>
                <input type="file" id="image" name="image" accept="image/*" class="form-input">
            </div>
        </div>

        <!-- Кнопки -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="{{ url_for('index') }}" class="btn btn-cancel">Отмена</a>
        </div>
        <!-- НОВОЕ: Поле для публикации -->
        <div class="form-group">
            <label>
                <input type="checkbox" name="is_published" value="1" {% if note.is_published %}checked{% endif %}> Опубликовать запись
            </label>
        </div>
    </form>
</div>

<script src="{{ url_for('static', filename='tinymce/tinymce.min.js') }}"></script>
<script>
  // Получаем значения шрифта и размера из формы
  function getEditorSettings() {
    const fontFamily = document.getElementById('font-family').value;
    const fontSize = document.getElementById('font-size').value;

    let defaultFontSize = '1rem';
    if (fontSize === 'small') {
      defaultFontSize = '0.875rem'; // ~14px
    } else if (fontSize === 'medium') {
      defaultFontSize = '1rem'; // ~16px
    } else if (fontSize === 'large') {
      defaultFontSize = '1.125rem'; // ~18px
    } else if (fontSize === 'x-large') {
      defaultFontSize = '1.25rem'; // ~20px
    }

    return {
      fontFamily: fontFamily,
      fontSize: defaultFontSize
    };
  }

  // Инициализируем TinyMCE
  tinymce.init({
    selector: '#mytextarea',
    plugins: 'table lists link image code help wordcount charmap hr anchor media embed codesample fullscreen',
    toolbar: 'undo redo | blocks fontfamily fontsizeinput | bold italic underline strikethrough subscript superscript | link image media embed | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | table | codesample hr | charmap | removeformat | help | fullscreen',
    height: 400, // Увеличим высоту
    // Настройка загрузки изображений
    images_upload_handler: function (blobInfo, success, failure, progress) {
        var formData = new FormData();
        formData.append('file', blobInfo.blob(), blobInfo.filename());

        fetch('/upload_image', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.location) {
                success(data.location);
            } else {
                failure(data.error || 'HTTP Error');
            }
        })
        .catch(err => failure('Image upload failed: ' + err));
    },
    // Дополнительные настройки
    menubar: 'file edit view insert format tools table help',
    branding: false,
    skin: 'oxide',

    // --- Настройка стилей по умолчанию ---
    setup: function (editor) {
      editor.on('init', function () {
        const settings = getEditorSettings();
        // Устанавливаем стиль для содержимого редактора
        editor.dom.setStyles(editor.getBody(), {
          'font-family': settings.fontFamily,
          'font-size': settings.fontSize
        });
      });

      // Обновляем стиль при изменении выбора в форме
      document.getElementById('font-family').addEventListener('change', function () {
        const settings = getEditorSettings();
        editor.dom.setStyles(editor.getBody(), {
          'font-family': settings.fontFamily,
          'font-size': settings.fontSize
        });
      });

      document.getElementById('font-size').addEventListener('change', function () {
        const settings = getEditorSettings();
        editor.dom.setStyles(editor.getBody(), {
          'font-family': settings.fontFamily,
          'font-size': settings.fontSize
        });
      });
    },

    // --- /Настройка стилей по умолчанию ---
  });
</script>

{% endblock %}