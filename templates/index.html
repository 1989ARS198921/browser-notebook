<!-- templates/index.html -->
<!-- -*- coding: utf-8 -*- -->
{% extends "base.html" %}
{% block sidebar %}
    {% include 'sidebar.html' %}
{% endblock %}

{% block title %}Админ-панель{% endblock %}

{% block content %}
<div class="content-card">
    <div class="card-header">
        <h2>Админ-панель</h2>
        <a href="{{ url_for('create_note') }}" class="btn btn-primary">+ Новая запись</a>
        <a href="{{ url_for('create_article') }}" class="btn btn-primary">+ Новая статья</a>
    </div>

    <!-- Форма фильтрации -->
    <form id="filter-form" method="GET" class="search-form">
        <input type="text" name="search" value="{{ request.args.get('search', '') }}" placeholder="Поиск..." class="search-input">
        <select name="category" class="form-select">
            <option value="">Все категории</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}" {% if request.args.get('category', type=int) == cat.id %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
        </select>
        <select name="tag" class="form-select">
            <option value="">Все теги</option>
            {% for tag in all_tags %}
                <option value="{{ tag.strip() }}" {% if request.args.get('tag') == tag.strip() %}selected{% endif %}>{{ tag.strip() }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-secondary">Фильтровать</button>
        {% if request.args.get('search') or request.args.get('category') or request.args.get('tag') %}
            <a href="{{ url_for('admin_index') }}" class="btn btn-cancel">Сбросить</a>
        {% endif %}
    </form>

    <!-- Таблица записей -->
    <div class="table-responsive">
        <table class="notes-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">ID &#9650;&#9660;</th>
                    <th onclick="sortTable(1)">Заголовок &#9650;&#9660;</th>
                    <th onclick="sortTable(2)">Тип &#9650;&#9660;</th>
                    <th onclick="sortTable(3)">Дата обновления &#9650;&#9660;</th>
                    <th onclick="sortTable(4)">Опубликовано &#9650;&#9660;</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
            {% for note in notes %}
                <tr data-id="{{ note.id }}">
                    <td>{{ note.id }}</td>
                    <td>{{ note.title or 'Без заголовка' }}</td>
                    <td>{{ 'Статья' if note.note_type == 'article' else 'Заметка' }}</td>
                    <td>{{ note.updated_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td>{{ 'Да' if note.is_published else 'Нет' }}</td>
                    <td>
                        <a href="{{ url_for('edit_note', id=note.id) if note.note_type != 'article' else url_for('edit_article', id=note.id) }}" class="btn btn-edit btn-sm">Редактировать</a>
                        <form action="{{ url_for('delete_note', id=note.id) }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-delete btn-sm" onclick="return confirm('Удалить запись?')">Удалить</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
  // --- Простая сортировка таблицы ---
  function sortTable(columnIndex) {
      const table = document.querySelector('.notes-table');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      // Определяем направление сортировки (временно просто переключаем между asc/desc)
      const isAscending = table.getAttribute('data-sort-order') !== 'asc';
      table.setAttribute('data-sort-order', isAscending ? 'asc' : 'desc');

      rows.sort((a, b) => {
          const aValue = a.cells[columnIndex].textContent.trim();
          const bValue = b.cells[columnIndex].textContent.trim();

          // Попробуем сортировать как числа, если возможно
          const aNum = parseFloat(aValue);
          const bNum = parseFloat(bValue);
          if (!isNaN(aNum) && !isNaN(bNum)) {
              return isAscending ? aNum - bNum : bNum - aNum;
          }

          // Иначе как строки
          if (isAscending) {
              return aValue.localeCompare(bValue, undefined, { numeric: true });
          } else {
              return bValue.localeCompare(aValue, undefined, { numeric: true });
          }
      });

      // Перестраиваем tbody
      rows.forEach(row => tbody.appendChild(row));
  }

  // --- /Простая сортировка таблицы ---
</script>

<style>
  /* --- Стили для таблицы --- */
  .table-responsive {
      overflow-x: auto;
  }

  .notes-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
  }

  .notes-table th,
  .notes-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
  }

  .notes-table th {
      background-color: var(--sidebar-bg-color);
      color: var(--text-color);
      font-weight: 600;
      cursor: pointer; /* Для сортировки */
      user-select: none; /* Запрещаем выделение текста при клике */
  }

  .notes-table th:hover {
      background-color: var(--sidebar-link-hover-bg);
  }

  .notes-table tr:nth-child(even) {
      background-color: var(--sidebar-bg-color);
  }

  .notes-table tr:hover {
      background-color: var(--bg-color);
  }

  .btn-sm {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
  }
  /* --- /Стили для таблицы --- */
</style>

{% endblock %}