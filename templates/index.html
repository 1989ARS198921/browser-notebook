<!-- templates/index.html -->
{% extends "base.html" %}
{% block sidebar %}
    {% include 'sidebar.html' %}
    <!-- Добавим список категорий в боковую панель -->
    <div class="sidebar-section">
        <h4>Категории</h4>
        <ul>
            <li><a href="{{ url_for('index') }}">Все</a></li>
            {% for cat in categories %}
                <li><a href="{{ url_for('index', category=cat.id) }}">{{ cat.name }}</a></li>
            {% endfor %}
        </ul>
        <a href="{{ url_for('list_categories') }}">Управление категориями</a>
    </div>
{% endblock %}

{% block content %}
<div class="container">
    <a href="{{ url_for('create_note') }}" class="btn">+ Новая запись</a>
    <h2>Список записей</h2>

    <!-- Форма поиска -->
    <form method="GET" style="margin-bottom: 1rem;">
        <input type="text" name="search" value="{{ search_query }}" placeholder="Поиск...">
        <input type="hidden" name="category" value="{{ selected_category }}"> <!-- Сохраняем выбранную категорию -->
        <button type="submit" class="btn">Найти</button>
        {% if search_query %}
            <a href="{{ url_for('index', category=selected_category) }}" class="btn btn-cancel">Сбросить</a>
        {% endif %}
    </form>

    {% if notes %}
        <ul class="notes-list">
        {% for note in notes %}
            <li class="note-item">
                <h3><a href="{{ url_for('view_note', id=note.id) }}">{{ note.title }}</a></h3>
                <p class="note-type">Тип: {{ 'Статья' if note.note_type == 'article' else 'Заметка' }}</p>
                <!-- Отображение категорий -->
                {% if note.category_ids %}
                    <p class="note-categories">
                        Категории:
                        {% for cid in (note.category_ids.split(',')) %}
                            {% set cat = categories | selectattr("id", "equalto", cid | int) | first %}
                            {% if cat %}<span class="tag">{{ cat.name }}</span>{% endif %}
                        {% endfor %}
                    </p>
                {% endif %}
                {% if note.image_filename %}
                    <p><img src="{{ url_for('static', filename='uploads/' + note.image_filename) }}" alt="Изображение к записи" style="max-width: 200px;"></p>
                {% endif %}
                <p class="note-preview">{{ note.content[:100] }}{% if note.content|length > 100 %}...{% endif %}</p>
                <small>Создано: {{ note.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                <div class="note-actions">
                    <a href="{{ url_for('edit_note', id=note.id) }}" class="btn btn-edit">Редактировать</a>
                    <form action="{{ url_for('delete_note', id=note.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-delete" onclick="return confirm('Удалить запись?')">Удалить</button>
                    </form>
                </div>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>Записей не найдено.</p>
    {% endif %}
</div>
{% endblock %}